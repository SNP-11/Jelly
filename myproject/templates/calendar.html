<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALENDAR</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            font-weight: bold;
            font-size: 1.5vw;
            margin-bottom: 10px;
            color: #ffffff; /* White text for header */
            background-color: #333333; /* Dark background for header */
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .current-day {
            border: 4px dashed rgb(255, 217, 0);
        }
        .day {
            position: relative;
            width: 100%; 
            height: 6.5vw; 
            max-height: 150px; 
            background-color: #ffffff;
            border-radius: 6px;
            font-size: 1.5vw;
            display: grid; /* Use CSS Grid for layout */
            grid-template-columns: repeat(auto-fit, minmax(30px, 1fr)); /* Dynamically adjust columns */
            gap: 5px; /* Add spacing between smallDivs */
            color: #000000; 
            overflow: hidden; 
            box-sizing: border-box; 
            padding: 5px; 
            }

            .smallDiv {
                height: 43px; /* Set a fixed height */
                border-radius: 3px;
                display: flex; /* Enable flexbox for the smallDiv */
                justify-content: center; /* Center content horizontally */
                align-items: center; /* Center content vertically */
                background-color: #f3ca45; /* Default background color */
                color: #000000; /* Default text color */
                font-size: clamp(0.5rem, 1vw, 1rem); /* Dynamically adjust font size */
                text-align: center;
                margin-top: 30px;
                /* overflow: hidden; Prevent text overflow */
                white-space: nowrap; /* Prevent text wrapping */
                text-overflow: ellipsis; /* Add ellipsis if text overflows */
            }
                    .day-number {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 1vw;
            font-weight: bold;
        }
        .hidden {
            visibility: hidden;
        }
        .month-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .nav-button {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 2vw;
            cursor: pointer;
        }
        .month-label{
            font-family: 'Times New Roman', Times, serif;
        }
        .side-menu {
            background-color: rgba(255, 198, 76);
            width: 250px;
            border-radius: 15px;
            overflow-x: hidden;
            padding-top: 60px;
            padding-left: 15px;
            padding-right: 15px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 10; /* Higher than calendar */
            transform: translateX(-100%); /* Collapsed on load */
            transition: transform 0.3s ease-in-out;
        }

        .calendar {
            width: 90vw;
            height: 90vh;
            background-color: #212529;
            border-radius: 8px;
            color: #ffffff;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            z-index: 5; /* Lower than sidebar */
        }

        /* Links inside the sidebar */
        .side-menu a {
            padding: 15px 0;
            text-decoration: none;
            font-size: 24px;
            color: #fff;
            display: block;
            border-radius: 5px;
        }

        .side-menu a:hover {
            color: rgb(56, 21, 230);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .toggle-btn {
            top: 20px;
            left: 10px;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 1.5rem;
            z-index: 11; /* Above sidebar */
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
            border-radius: 10px;
            background-color: rgb(62, 79, 226);
            position: fixed; /* Fix the button in place */
        }
        .side-menu.open {
        transform: translateX(0);
        }
        
    </style>
</head>
<body>
    <button id="toggleButton" class="toggle-btn" onclick="toggleMenu()">&#9681;</button>
    <div id="container" class="main-container">
        <div id="sideMenu" class="side-menu">
            <a href="/home">HOME</a>
            <a href = "/reward">ACHIEVEMENTS</a>
            <a href="/timeout">TIMEOUT</a>
            <a href="/signout">LOG OUT</a>
        </div>
    <div class="calendar">
        <div class="month-navigation">
            <button class="nav-button" id="prevMonth">&#8249;</button>
            <span id="monthLabel"></span>
            <button class="nav-button" id="nextMonth">&#8250;</button>
        </div>
        <div class="calendar-header">
            <span>SUN</span><span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const colordict = {
            "Very Important": "#f89099", // Light red for very urgent
            "Important": "#f3ca45",      // Yellow for urgent
            "Not Important": "#6adb82"   // Green for not urgent
        };
        const secInWeek = 604800;
        function getSundayStartOfWeek() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const diff = dayOfWeek; // Days to subtract to reach Sunday
            const sunday = new Date(now);
            sunday.setDate(now.getDate() - diff);
            sunday.setHours(0, 0, 0, 0); // Start of the day

            return Math.floor(sunday.getTime() / 1000); // Convert to Unix timestamp in seconds
        }
        const sundayTimestamp = getSundayStartOfWeek();


        function toggleMenu() {
            const sideMenu = document.getElementById("sideMenu");
            sideMenu.classList.toggle("open");
        }

        function getMonthData(startYear, numYearsBefore, numYearsAfter) {
            const monthData = {};
            for (let year = startYear - numYearsBefore; year <= startYear + numYearsAfter; year++) {
                for (let month = 0; month < 12; month++) {
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const key = `${year}-${String(month + 1).padStart(2, '0')}`;
                    monthData[key] = { days: daysInMonth, start: firstDay };
                }
            }
            return monthData;
        }

        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthData = getMonthData(currentYear, 2, 2); // Generates data for 2 years before and 2 years after

        const monthLabel = document.getElementById("monthLabel");

        function generateCalendar(year, month) {
            const calendarGrid = document.getElementById("calendarGrid");
            calendarGrid.innerHTML = "";

            // Dynamically generate more data if we go beyond the preloaded range
            if (!monthData[`${year}-${String(month + 1).padStart(2, '0')}`]) {
                Object.assign(monthData, getMonthData(year, 2, 2));
            }

            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            const { days, start } = monthData[monthKey];

            monthLabel.textContent = `${monthNames[month]} ${year}`;

            const today = new Date();
            const isCurrentMonth = year === today.getFullYear() && month === today.getMonth();

            for (let i = 0; i < start; i++) {
                calendarGrid.innerHTML += '<div class="day hidden"></div>';
            }

            for (let i = 1; i <= days; i++) {
                let className = "day";
                if (isCurrentMonth && i === today.getDate()) {
                    className += " current-day";
                }
                let date = Date.UTC(year, month, i) / 1000;
                calendarGrid.innerHTML += `<div class="${className}" data-date="${date}"><div class="day-number">${i}</div></div>`;
            }

            // Load tasks for the current month
            loadTasksForMonth(year, month);
        }

        function loadTasksForMonth(year, month) {
            $.ajax({
                type: "POST",
                url: "/get_tasks",
                success: function (data) {
                    console.log("Tasks received from server:", data); // Debugging log
                    const tasks = data;

                    tasks.forEach(task => {
                        const startDate = new Date(task.start_time * 1000);
                        const endDate = new Date(task.end_time * 1000);

                        // Normalize task timestamps to UTC midnight
                        startDate.setUTCHours(0, 0, 0, 0);
                        endDate.setUTCHours(0, 0, 0, 0);

                        // Loop through all days from startDate to endDate
                        for (let date = new Date(startDate); date <= endDate; date.setUTCDate(date.getUTCDate() + 1)) {
                            const dayTimestamp = Math.floor(date.getTime() / 1000); // Convert to Unix timestamp
                            const dayElement = document.querySelector(`.day[data-date="${dayTimestamp}"]`);

                            if (dayElement) {
                                console.log(`Adding task "${task.label}" to day: ${new Date(dayTimestamp * 1000).toLocaleDateString()}`); // Debugging log
                                const taskDiv = document.createElement("div");
                                taskDiv.className = "smallDiv";
                                taskDiv.dataset.id = task.id;
                                taskDiv.dataset.uid = task.uid;
                                taskDiv.dataset.label = task.label;
                                taskDiv.dataset.start_time = task.start_time;
                                taskDiv.dataset.end_time = task.end_time;
                                taskDiv.dataset.urgency = task.urgency;
                                taskDiv.style.backgroundColor = colordict[task.urgency];
                                taskDiv.innerText = task.label; // Add task label for display

                                // Add click event listener to navigate to the task page
                                taskDiv.addEventListener("click", function () {
                                    const taskStartTime = this.dataset.start_time; // Get the task's start time
                                    const taskDate = Math.floor(taskStartTime - (taskStartTime % 86400)); // Normalize to midnight (UTC)

                                    // Redirect to the home page with the selected date as a query parameter
                                    window.location.href = `/home?date=${taskDate}`;
                                });

                                dayElement.appendChild(taskDiv);
                            } else {
                                console.warn(`No day element found for timestamp: ${dayTimestamp}`); // Debugging log
                            }
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching tasks:", error); // Debugging log
                }
            });
        }

        document.addEventListener("click", function(event) {
            if (event.target.classList.contains("day")) {
                let timestamp = parseInt(event.target.dataset.date); // Get the timestamp from the clicked day
                timestamp = Math.floor(timestamp - (timestamp % 86400)); // Normalize to midnight

                const sundayTimestamp = getSundayStartOfWeek(); // Get the normalized Sunday timestamp
                const daysDifference = (timestamp - sundayTimestamp) / 86400; // Difference in days

                // Adjust the week offset calculation to handle Sundays correctly
                const weekOffset = Math.floor((daysDifference + 1) / 7); // Add 1 to include Sunday in the current week

                console.log("Selected Timestamp:", timestamp);
                console.log("Sunday Timestamp:", sundayTimestamp);
                console.log("Days Difference:", daysDifference);
                console.log("Week Offset:", weekOffset);

                localStorage.setItem("weekOffset", weekOffset);
                localStorage.setItem("startDay", timestamp);
                window.location.href = "/home"; // Uncomment if redirection is needed
            }
        });

        document.getElementById("prevMonth").addEventListener("click", function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar(currentYear, currentMonth);
        });

        document.getElementById("nextMonth").addEventListener("click", function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentYear, currentMonth);
        });

        generateCalendar(currentYear, currentMonth);
    </script>
</body>
</html>